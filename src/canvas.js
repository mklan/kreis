import { fabric } from 'fabric';

let mouseDown = false;

function createCanvas(
  canvasEl,
  {
    onStartDrawing = () => {},
    onMove = () => {},
    onEnd = () => {},
    init = () => {},
  },
) {
  fabric.Object.prototype.selectable = false;
  fabric.Object.prototype.transparentCorners = false;

  const canvas = new fabric.StaticCanvas(canvasEl, {
    isDrawingMode: true,
  });

  // canvas.freeDrawingBrush.color = '#F25F5C';
  // canvas.freeDrawingBrush.width = 10;

  let containerSize = {
    width: document.getElementById('canvas-container').offsetWidth,
    height: document.getElementById('canvas-container').offsetHeight,
  };

  function fitResponsiveCanvas() {
    containerSize = {
      width: document.getElementById('canvas-container').offsetWidth,
      height: document.getElementById('canvas-container').offsetHeight,
    };
    canvas.setWidth(containerSize.width);
    canvas.setHeight(containerSize.height);
    canvas.setZoom(1);
  }

  fitResponsiveCanvas();
  window.onresize = fitResponsiveCanvas;

  function getCenter() {
    return { x: containerSize.width / 2, y: containerSize.height / 2 };
  }

  let drawingDisabled;
  function disableDrawing(bool) {
    drawingDisabled = bool;
  }

  function drawCircle({ x, y, fill, stroke, strokeWidth, radius }) {
    const circle = new fabric.Circle({
      fill,
      stroke,
      strokeWidth,
      radius,
      left: x,
      top: y,
      centeredScaling: true,
      originX: 'center',

      originY: 'center',
    });

    canvas.add(circle);
    canvas.sendToBack(circle);
    return circle;
  }

  const api = {
    getCenter,
    drawCircle,
    reset,
    disableDrawing,
    canvas,
  };

  function reset() {
    canvas.clear();
    init(api);
  }

  let path;
  document.body.onmousedown = ({ clientX, clientY }) => {
    reset();
    path = new fabric.Path(`M ${clientX} ${clientY}`, {
      strokeWidth: 10,
      stroke: '#F25F5C',
      fill: '',
      selectable: false,
      hasRotatingPoint: false,
      objectCaching: false,
    });
    path.id = Date.now();
    canvas.add(path);
    disableDrawing(false);
    onStartDrawing({ x: clientX, y: clientY }, api);
    mouseDown = true;
    canvas.renderAll();
  };

  document.body.onmouseup = ({ clientX, clientY }) => {
    mouseDown = false;
    if (drawingDisabled) return;
    onEnd({ x: clientX, y: clientY }, api);
  };

  document.body.onmousemove = ({ clientX, clientY }) => {
    if (!mouseDown || drawingDisabled) return;
    const newLine = ['L', clientX, clientY];
    path.path.push(newLine);
    onMove({ x: clientX, y: clientY }, api);
    canvas.renderAll();
  };

  init(api);
}

export default createCanvas;
